---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zap-scan-plans
data:
  scan-plan-test1.yaml: |
    env:
      contexts:
        - name: app-ctx
          urls:
            - http://juiceshop-svc.juiceshop.svc.cluster.local:3080/
            # - http://juiceshop.tawa.local/
          includePaths:
            - https?://juiceshop-svc.juiceshop.svc.cluster.local:3080/.* 
            # - https?://juiceshop.tawa.local/.*
          technology:
            exclude: [HypersonicSQL, Oracle, ASP, Windows, IIS]
      parameters:
        failOnError: true
        failOnWarning: false
        continueOnFailure: false
        progressToStdout: true
    jobs:
      - type: passiveScan-config
        parameters:
          maxAlertsPerRule: 10
          scanOnlyInScope: true
      - type: spiderAjax
        parameters:
          context: app-ctx
          maxDuration: 0
          maxCrawlDepth: 10
          runOnlyIfModern: false
          inScopeOnly: true
          browserId: firefox-headless
          clickDefaultElems: true
          clickElemsOnce: true
          maxCrawlStates: 0
      - type: passiveScan-wait
        parameters:
          maxDuration: 30
      - type: report
        parameters:
          template: traditional-html
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
          reportTitle: Findings in JuiceShop
          reportDescription: Runs SpiderAjax & PassiveScan [ JuiceShop ]
      - type: report
        parameters:
          template: traditional-xml
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
  scan-plan-test2.yaml: |
    env:
      contexts:
        - name: app-ctx
          urls:
            - http://test-cyberchef-zws-dev-security-common.test-waf-cf.svc.cluster.local/
          includePaths:
            - https?://test-cyberchef-zws-dev-security-common.test-waf-cf.svc.cluster.local/.* 
          technology:
            exclude: [HypersonicSQL, MariaDB, Oracle, MySQL, PHP, ASP, Windows, IIS]
      parameters:
        failOnError: true
        failOnWarning: false
        continueOnFailure: false
        progressToStdout: true 
    jobs:
      - type: passiveScan-config
        parameters:
          maxAlertsPerRule: 10
          scanOnlyInScope: true
      - type: spiderAjax
        parameters:
          context: app-ctx
          maxDuration: 0
          maxCrawlDepth: 10
          runOnlyIfModern: false
          inScopeOnly: true
          browserId: firefox-headless
          clickDefaultElems: true
          clickElemsOnce: true
          maxCrawlStates: 0
      - type: passiveScan-wait
        parameters:
          maxDuration: 30
      - type: report
        parameters:
          template: traditional-html
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
          reportTitle: Findings in CyberChef
          reportDescription: Runs SpiderAjax & PassiveScan [ CyberChef ]
      - type: report
        parameters:
          template: traditional-xml
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
  scan-plan-01.yaml: |
    env:
      contexts:
        - name: app-ctx
          urls:
            - http://console-zws-dev-front.console.svc.cluster.local:8080/
          includePaths:
            - https?://console-zws-dev-front.console.svc.cluster.local:8080/.* 
          technology:
            exclude: [HypersonicSQL, MariaDB, Oracle, MySQL, PHP, ASP, Windows, IIS]
      parameters:
        failOnError: true
        failOnWarning: false
        continueOnFailure: false
        progressToStdout: true 
    jobs:
      - type: passiveScan-config
        parameters:
          maxAlertsPerRule: 10
          scanOnlyInScope: true
      - type: spiderAjax
        parameters:
          context: app-ctx
          maxDuration: 0
          maxCrawlDepth: 10
          runOnlyIfModern: false
          inScopeOnly: true
          browserId: firefox-headless
          clickDefaultElems: true
          clickElemsOnce: true
          maxCrawlStates: 0
      - type: passiveScan-wait
        parameters:
          maxDuration: 30
      - type: report
        parameters:
          template: traditional-html-plus
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
          reportTitle: Findings in Console-Front 
          reportDescription: Runs SpiderAjax & PassiveScan [ Console-Front ]
      - type: report
        parameters:
          template: traditional-xml-plus
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
  scan-plan-02.yaml: |
    env:
      contexts:
        - name: app-ctx
          urls:
            - http://console-zws-dev-back.console.svc.cluster.local:3000/graphql
          includePaths:
            - https?://console-zws-dev-back.console.svc.cluster.local:3000/.* 
          technology:
            exclude: [HypersonicSQL, MariaDB, Oracle, MySQL, PHP, ASP, Windows, IIS]
      parameters:
        failOnError: true
        failOnWarning: false
        continueOnFailure: false
        progressToStdout: true 
    jobs:
      - type: passiveScan-config
        parameters:
          maxAlertsPerRule: 10
          scanOnlyInScope: true
      - type: spiderAjax
        parameters:
          context: app-ctx
          maxDuration: 0
          maxCrawlDepth: 10
          runOnlyIfModern: false
          inScopeOnly: true
          browserId: firefox-headless
          clickDefaultElems: true
          clickElemsOnce: true
          maxCrawlStates: 0
      - type: graphql
        parameters:
          endpoint: http://console-zws-dev-back.console.svc.cluster.local:3000/graphql
          requestMethod: post_json
          maxQueryDepth: 5
          maxArgsDepth: 5
      - type: passiveScan-wait
        parameters:
          maxDuration: 30
      - type: report
        parameters:
          template: traditional-html-plus
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
          reportTitle: Findings in Console-Back 
          reportDescription: Runs SpiderAjax, Graphql & PassiveScan [ Console-Back ]
      - type: report
        parameters:
          template: traditional-xml-plus
          reportDir: ${REPORT_DIR}
          reportFile: out-zap.${PRODUCT_NAME}.${REPORT_DATE}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zap-scan-policies
data:
  my-policy-01: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <configuration>
        <policy>my-policy-01</policy>
        <scanner>
            <level>MEDIUM</level>
            <strength>MEDIUM</strength>
        </scanner>
        <plugins>
            <p6>
                <enabled>true</enabled>
            </p6>
            <p7>
                <enabled>true</enabled>
            </p7>
            <p10045>
                <enabled>false</enabled>
                <level>OFF</level>
                <strength>DEFAULT</strength>
            </p10045>
            <p20015>
                <enabled>true</enabled>
            </p20015>
            <p20017>
                <enabled>true</enabled>
            </p20017>
            <p20018>
                <enabled>true</enabled>
            </p20018>
            <p20019>
                <enabled>true</enabled>
            </p20019>
            <p40009>
                <enabled>true</enabled>
            </p40009>
            <p40012>
                <enabled>true</enabled>
            </p40012>
            <p40014>
                <enabled>true</enabled>
            </p40014>
            <p40018>
                <enabled>true</enabled>
            </p40018>
            <p40019>
                <enabled>false</enabled>
                <level>OFF</level>
            </p40019>
            <p40020>
                <enabled>false</enabled>
                <level>OFF</level>
            </p40020>
            <p40021>
                <enabled>false</enabled>
                <level>OFF</level>
            </p40021>
            <p40022>
                <enabled>true</enabled>
            </p40022>
            <p40024>
                <enabled>false</enabled>
                <level>OFF</level>
            </p40024>
            <p40026>
                <enabled>true</enabled>
                <level>DEFAULT</level>
                <strength>DEFAULT</strength>
            </p40026>
            <p40027>
                <enabled>false</enabled>
                <level>OFF</level>
            </p40027>
            <p40043>
                <enabled>true</enabled>
            </p40043>
            <p40045>
                <enabled>true</enabled>
            </p40045>
            <p90019>
                <enabled>true</enabled>
            </p90019>
            <p90020>
                <enabled>true</enabled>
            </p90020>
            <p90021>
                <enabled>false</enabled>
                <level>OFF</level>
            </p90021>
            <p90023>
                <enabled>false</enabled>
                <level>OFF</level>
            </p90023>
            <p90024>
                <enabled>true</enabled>
            </p90024>
            <p90034>
                <enabled>true</enabled>
            </p90034>
            <p90035>
                <enabled>true</enabled>
            </p90035>
            <p90036>
                <enabled>true</enabled>
            </p90036>
            <p0>
                <enabled>true</enabled>
            </p0>
            <p30001>
                <enabled>true</enabled>
            </p30001>
            <p30002>
                <enabled>true</enabled>
            </p30002>
            <p40003>
                <enabled>true</enabled>
            </p40003>
            <p40008>
                <enabled>true</enabled>
            </p40008>
            <p40028>
                <enabled>true</enabled>
            </p40028>
            <p40029>
                <enabled>true</enabled>
            </p40029>
            <p40032>
                <enabled>true</enabled>
            </p40032>
            <p40034>
                <enabled>true</enabled>
            </p40034>
            <p40035>
                <enabled>true</enabled>
            </p40035>
            <p40042>
                <enabled>true</enabled>
            </p40042>
            <p90017>
                <enabled>false</enabled>
                <level>OFF</level>
            </p90017>
            <p10058>
                <enabled>true</enabled>
            </p10058>
            <p10104>
                <enabled>true</enabled>
            </p10104>
            <p40016>
                <enabled>true</enabled>
            </p40016>
            <p40017>
                <enabled>true</enabled>
            </p40017>
            <p50000>
                <enabled>true</enabled>
            </p50000>
            <p90026>
                <enabled>false</enabled>
                <level>OFF</level>
            </p90026>
            <p90029>
                <enabled>false</enabled>
                <level>OFF</level>
            </p90029>
        </plugins>
    </configuration>
  my-policy-02: |
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <configuration>
        <policy>my-policy-02</policy>
        <scanner>
            <level>OFF</level>
            <strength>MEDIUM</strength>
        </scanner>
        <plugins>
            <p20019>
                <name>External Redirect</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p20019>
            <p40012>
                <name>Cross Site Scripting (Reflected)</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p40012>
            <p40018>
                <name>SQL Injection</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p40018>
            <p50000>
                <name>Script Active Scan Rules</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p50000>
            <p90017>
                <name>XSLT Injection</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90017>
            <p90020>
                <name>Remote OS Command Injection</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90020>
            <p90021>
                <name>XPath Injection</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90021>
            <p90023>
                <name>XML External Entity Attack</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90023>
            <p90026>
                <name>SOAP Action Spoofing</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90026>
            <p90029>
                <name>SOAP XML Injection</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90029>
            <p90035>
                <name>Server Side Template Injection</name>
                <enabled>true</enabled>
                <level>MEDIUM</level>
            </p90035>
        </plugins>
    </configuration>
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: zap-reimport-script
data:
  run-zap-and-defectdojo-reimport-sh: |
    #!/bin/bash

    set -euo pipefail

    ## ZAP params
    PATH_TO_SCAN_PLAN="${1:-/zap/wrk/scan-plan-test2.yaml}"  ## Must be absolute path (test1=juiceshop, test2=cyberchef)
    REPORT_DIR="${2:-../out}"  ## Should be relative to /zap/wrk or absolute path
    REPORT_DATE=${3:-$(date +%y%m%d-%H%M%S)}
    ## DefectDojo params
    PRODUCT_NAME="${4:-JUICESHOP}"
    ENGAGEMENT_NAME="${5:-INTERNAL_PENTEST}"
    PRODUCT_TYPE_NAME="${6:-R&D}"
    ## DefectDojo params or env vars
    DD_HOST="${7:-${DD_HOST:defectdojo.tawa.local}}"
    DD_API_HOST="${8:-${DD_API_HOST:-http://defectdojo-django.defectdojo.svc.cluster.local}}"
    DD_API_TOKEN="${9:-${DD_API_TOKEN:?Token is mandatory}}"

    # Print params
    echo "* PATH_TO_SCAN_PLAN: ${PATH_TO_SCAN_PLAN}"
    echo "* REPORT_DIR: ${REPORT_DIR}"
    echo "* REPORT_DATE: ${REPORT_DATE}"
    echo "* PRODUCT_NAME: ${PRODUCT_NAME}"
    echo "* ENGAGEMENT_NAME: ${ENGAGEMENT_NAME}"
    echo "* PRODUCT_TYPE_NAME: ${PRODUCT_TYPE_NAME}"
    echo "* DD_HOST: ${DD_HOST}"
    echo "* DD_API_HOST: ${DD_API_HOST}"

    echo "********** Trigger ZAP scan and generate Report"

    REPORT_DIR=${REPORT_DIR} REPORT_DATE=${REPORT_DATE} PRODUCT_NAME=${PRODUCT_NAME} zap.sh -cmd -autorun ${PATH_TO_SCAN_PLAN} 

    echo "********** Upload ZAP Reports to DefectDojo"

    HEADER_AUTH="Authorization: Token ${DD_API_TOKEN}"
    HEADER_HOST="Host: ${DD_HOST}"

    # Get all ZAP XML reports by product name
    files_zap=$(find "${REPORT_DIR}" -maxdepth 1 -type f -iregex ".*/out-zap.*${PRODUCT_NAME}.*\.xml")
    echo "Matched ZAP XML reports filtered by $REPORT_DATE:"
    files_zap_matched=()
    for f in $files_zap; do
      if [[ $f == *"$REPORT_DATE"* && $f != *".imported"* && $f != *".failed"* ]]; then
        files_zap_matched+=("$f")
      fi
    done
    printf "%s\n" "${files_zap_matched[@]}"

    # Upload to DefectDojo all ZAP XML reports that weren't imported or failed
    counter_zap=0
    count_success=0
    count_fail=0

    for report in "${files_zap_matched[@]}"; do
      counter_zap=$(( counter_zap + 1 ))
      echo "Uploading $report ZAP report to DefectDojo"

      # Capture response body and HTTP status
      http_code=$(curl -sk -H "$HEADER_AUTH" -H "$HEADER_HOST" \
        -X POST "${DD_API_HOST}/api/v2/reimport-scan/" \
        -F "file=@${report};type=application/xml" \
        -F "scan_type=ZAP Scan" \
        -F "product_name=${PRODUCT_NAME}" \
        -F "engagement_name=${ENGAGEMENT_NAME}" \
        -F "product_type_name=${PRODUCT_TYPE_NAME}" \
        -F "active=true" \
        -F "verified=true" \
        -F "scan_date=$(date +%Y-%m-%d)" \
        -F "minimum_severity=Low" \
        -F "auto_create_context=true" \
        -F "engagement_end_date=$(date -d '+14 days' +%Y-%m-%d)" \
        -F "deduplication_on_engagement=true" \
        -F "close_old_findings=true" \
        -w '%{http_code}' \
        -o /tmp/dd_response.json)

      # Read response body (if JSON) or raw
      detail=$(jq -r '.detail // .message // empty' /tmp/dd_response.json 2>/dev/null)

      if [[ "$http_code" =~ ^2 ]]; then
        count_success=$(( count_success + 1 ))
        newname="${report%.xml}.imported.xml"
        mv -- "$report" "$newname"
        echo "✓ Re-import succeeded, renamed to $newname"
      else
        count_fail=$(( count_fail + 1 ))
        newname="${report%.xml}.failed.xml"
        mv -- "$report" "$newname"
        if [[ -n "$detail" ]]; then
          echo "✗ Re-import failed (HTTP $http_code): $detail, renamed to $newname"
        else
          echo "✗ Re-import failed (HTTP $http_code), renamed to $newname"
        fi
      fi
    done

    if (( count_success == 0 )); then
      echo "No ZAP XML reports were re-imported successfully."
    elif (( count_success == 1 )); then
      echo "Just one ZAP XML report was re-imported successfully."
    else
      echo "All $count_success ZAP XML reports were re-imported successfully."
    fi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zap-scan
  labels:
    app: zap-scan
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zap-scan
  template:
    metadata:
      labels:
        app: zap-scan
    spec:
      securityContext:
        # Get it running: echo $(id -u):$(id -g)
        fsGroup: 1000
      containers:
        - name: zap
          # image: ghcr.io/zama-ai/security-hub/sec/zap:2.16.1
          image: zaproxy/zap-stable:2.16.1
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - >
                    mkdir -p /sec-reports/zap/
          command: ["tail"]
          args: ["-f", "/dev/null"]
          env:
            - name: DD_HOST
              value: 'defectdojo.tawa.local'
            - name: DD_API_HOST
              value: 'http://defectdojo-django.defectdojo.svc.cluster.local'
            - name: DD_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: dd-api-token
                  key: token
                  optional: true
          volumeMounts:
            - name: sec-reports-dir
              mountPath: /sec-reports/
            - name: zap-scan-plans-dir
              mountPath: /zap/wrk/plans/
            - name: zap-scan-policies-dir
              subPath: my-policy-01
              mountPath: /home/zap/.ZAP/policies/my-policy-01.policy
            - name: zap-scan-policies-dir
              subPath: my-policy-02
              mountPath: /home/zap/.ZAP/policies/my-policy-02.policy
            - name: zap-reimport-script
              subPath: run-zap-and-defectdojo-reimport-sh
              mountPath: /zap/wrk/run-zap-and-defectdojo-reimport.sh
      volumes:
        - name: sec-reports-dir
          persistentVolumeClaim:
            claimName: sec-reports-pvc
        - name: zap-scan-plans-dir
          configMap:
            name: zap-scan-plans
        - name: zap-scan-policies-dir
          configMap:
            name: zap-scan-policies
        - name: zap-reimport-script
          configMap:
            name: zap-reimport-script
---

# kubectl -n dast apply -f zap-scan-deployment.yaml 
# kubectl exec -it -n dast deployment.apps/zap-scan -- bash
# $ ls -la /sec-reports/
# $ ls -la /sec-reports/trivy-op/
# $ ls -la /sec-reports/zap/
# $ now=$(date +%y%m%d-%H%M%S)
# $ REPORT_DATE=$now REPORT_DIR=/sec-reports/zap PRODUCT_NAME=JUICESHOP zap.sh -cmd -autorun /zap/wrk/plans/scan-plan-test1.yaml